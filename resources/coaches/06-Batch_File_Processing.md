---
ms.openlocfilehash: 4731750397d38964f248b031242f13a6027c0497
ms.sourcegitcommit: 27a4afc732f8733e6022af2a58d01af5ae83545b
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/23/2022
ms.locfileid: "140813667"
---
# <a name="process-distributor-order-batch-files"></a>ディストリビューターの注文バッチ ファイルを処理する

## <a name="progress-diagram"></a>進行状況ダイアグラム

![ディストリビューターの注文バッチ ファイル処理の進行状況ダイアグラム](https://serverlessoh.azureedge.net/public/order-batch-files-progress-diagram.jpg)

## <a name="happy-path"></a>ハッピー パス

次のいずれかのオプション:

* 2 つのファイルが同時に表示されるかどうかを照会する 1 つの Azure 関数への Event Grid トリガー。ストレージからのファイルの同時読み取りで問題が発生する可能性があります。関数内の各バッチに対して追加のファイルを作成し、関数コード内のファイルにリースを設定します。また、これを回避するために、ファイルに既にリースがある場合は常に再試行を追加します
* ファイルのコンテンツを SQL DB または CosmosDB に読み込む Azure 関数への Event Grid、および 3 つすべてのコンテンツがあるかどうかを随時確認し、それらを別の Cosmos コレクションにマージする別個の関数
* 最初のファイルが到着したときに各バッチのサブオーケストレーターを作成し、次に他のファイルに対して RaiseEventAsync を作成する、Durable Functions への Event Grid。サブオーケストレーターは、3 つのファイルすべての詳細を使用してアクティビティ関数を実行します。アクティビティ関数は、データを解析して Cosmos に挿入します (注文ごとに 1 つ)  
* バッチ トリガーを含む Logic Apps (3 メッセージ後にリリースするようにバッチ トリガーが構成されている 2 つ目の LA にファイルに関する情報を送信するイベント グリッドを備えた 1 つの LA) と、バッチ トリガーされた LA によって呼び出され、ファイルの読み込み、解析、および Cosmos への挿入を処理する Azure 関数を使用します

## <a name="coaches-notes"></a>コーチ向けメモ

* 場合によっては、コーチとして、アプローチ方法について積極的にサポートしてください。

* ストレージ アカウントを登録するために送信する場合、チームは一意のテーブル番号を使用する必要があります。  送信用の API については、[こちら](https://serverlessohmanagementapi.trafficmanager.net/api/definition)を参照してください。  重要なのは、チームのテーブル番号が seattle-table-1 や london-table-8 のように一意の番号であるということです。  チームのテーブル番号が割り当てられていない場合は、チームに対して、一意のテーブル名を使用し、後の手順で必要になるため、その名前を書き留めておくよう案内します。  これにより、48 時間から 72 時間にわたり、ストレージ アカウントに大量のトラフィックが送信されることに注意してください。  OH がアクティブな間は接続を切断しないように通知してください。これは、今後の課題に備えて登録をアクティブにしておく必要があるためです。接続を切断すると、登録が解除されます。

>注: 学生アカウントも、登録から 72 時間 (3 日) 以上経過すると登録解除されます。  このしきい値に達した学生に対しては、処理を再開するためにストレージ アカウントを再登録するように案内します。

* *serverlessohmanagementapi* アプリケーションでは大文字と小文字が区別されるため、本文内のすべてのパラメーターが呼び出しごとに正確に一致している必要があります。また、ファイル名と Azure Storage 内のファイルへのリンクにおいて大文字と小文字の違いがあってはいけません。  各メソッドの完全な本文構成要件については、Swagger のドキュメントを参照してください。

* Node.js の Durable Functions は、Azure Functions ランタイムのバージョン 2.x でのみサポートされます。 Durable Functions 拡張機能のバージョン 1.7.0 以降が必要です。

* Python と Java では、現在、Durable Functions はサポートされていません。 これらのチームでは、この課題を完了するために別の方法を使用する必要があります。

* チームのストレージ アカウント コンテナーがプライベートである場合は、/order/combineOrderContent エンドポイントに提供される url に SAS トークンが含まれている必要があります。

* Cosmos DB の出力バインディングでは、例外処理は許可されていません。 チームで使用するトリガー アプローチに応じて、データベースへの保存中に発生したエラーがさまざまな形で現れます。 この件とこれに対処するさまざまな方法についてチームに話し合ってもらいます。

* CosmosDB テーブルが登録されると、"id"、"FileName"、"filename" などのパーティション キーが使用されます。  パーティション キーが "FileName" であると仮定した場合、ロジック アプリ コネクタは、接続し、これらの設定手順に従う必要があります。  

    * DatabaseID: 接続から選択  
    * CollectionID: 接続から選択  
    * Document: 左右の中かっこに続けて、関連付けられた値を含む各フィールドを引用符で囲んで指定します。それぞれのフィールドはコンマで区切ります。  **このドキュメントには、必ずパーティション キーとその値を含めてください。**  

    * 新しいパラメーターを追加し、[Partition Key Value]\(パーティション キー値\) を選択します。  結果のテキスト ボックスに、(上のドキュメントに一致するように) パーティション キーの値を引用符で囲んで追加します。  たとえば、"パーティション キー値" を示す編集不可能なテキストが左側にあり、情報を入力するためのテキスト ボックスが右側にあります。  そのテキストボックスに、パーティション キーの **値** を引用符で囲んで追加します (例: **"myorderfile.xls"** )。  キーは実行ごとに変わる可能性が高いため、変数を使用してパーティション キーの値を保存することをお勧めします。  

* Logic Apps で CosmosDB に書き込む場合は、パーティション キー パラメーターを新しいパラメーターとして CosmosDB の作成または更新ドキュメント コネクタに追加する必要があります。 値は引用符で囲む必要があります。  また、パーティションは、作成するドキュメントの本文の一部として送信する必要があります。  ドキュメントとパーティション キー値パラメーターの両方でパーティション キーの値が表示されない場合、ドキュメントの作成または更新は機能しません。   さらに、デザイナー JSON を確認し、"x-ms-documentdb-raw-partitionkey" に値が設定されていることを検証できます。  

* Microsoft.EventGrid リソース プロバイダーが参加者サブスクリプションに登録されていないことを示すエラーが発生した場合は、[Event Grid リソース プロバイダーを有効にする](https://docs.microsoft.com/en-us/azure/event-grid/custom-event-quickstart-portal)方法に関する記事の手順に従って EventGrid リソース プロバイダーを登録してください  

## <a name="why-azure-functions-azure-logic-apps-azure-event-grid-and-azure-storage"></a>Azure Functions、Azure Logic Apps、Azure Event Grid、および Azure Storage を使用する理由

### <a name="azure-functions"></a>Azure Functions

* Azure 関数を使用すると、チームで記述するコードと保守するインフラストラクチャが少なくなり、コストを節約できます。
* Azure 関数は、軽量でスタンドアロンです。  関数を使用すると、モノリシック アプリケーションを簡単に分割し、リード時間またはサイクル時間を短縮できます。これにより、チームは、コードをより迅速かつ効率的に運用環境に移行できます。

### <a name="azure-logic-apps"></a>Azure Logic Apps

* ロジック アプリは、200 個を超えるコネクタを使用して、ほとんど何にでも接続できます。ロジック アプリは、任意のタイミングで、スケジュールに従って、またはイベントへの応答としてトリガーできます
* ロジック アプリは簡単に使用できます。ロジック アプリのワークフローは強力なドラッグ アンド ドロップ エディター アプローチを使用してごくわずかの構成で作成できるため、チームは複雑なロジックをすばやく簡単に調整できます

### <a name="azure-event-grid"></a>Azure Event Grid

* イベントベースのアーキテクチャを使用したアプリケーションを簡単に作成できます
* 特定のイベントを別々のエンドポイントにルーティングする、複数のエンドポイントにマルチキャストする、イベントが確実に配信されるようにすることができます

### <a name="azure-storage"></a>Azure Storage

* ストレージは耐久性、拡張性、高可用性を備えています。 一時的なハードウェア障害が発生した場合でも冗長性によってデータの安全性が保証される一方、現在のアプリケーションのニーズに対応できるように大幅に拡張できます
* 組み込みの暗号化ときめ細かなアクセス制御を通じて、ユーザーにアクセスを許可する必要があるストレージ データのみが公開されるように、詳細かつ厳密なアクセス権を構成することができるため、ストレージはセキュリティで保護されます。
